# U盾/CA证书到期提醒系统 - 项目开发总结报告

**版本**: 1.1.0  
**日期**: 2026-01-16  
**作者**: 海边的飞行器 (18520403199)

---

## 1. 项目背景与目标
针对企业或个人持有的关键资产（如银行U盾、CA数字证书、域名、服务器、保险等）存在有效期管理困难、容易遗忘续费导致业务中断的痛点，开发一套轻量级、高可靠的**自动化到期提醒系统**。

核心目标是实现“**零遗漏**”的通知机制，通过高频、多渠道触达用户，直至用户完成续费更新。

## 2. 技术架构

本项目采用现代化的 **Serverless** 和 **BaaS (Backend as a Service)** 架构，确保了系统的低成本、高可用和易维护性。

*   **前端 (Frontend)**:
    *   **框架**: React + TypeScript + Vite
    *   **UI库**: Tailwind CSS + Headless UI
    *   **图标**: Lucide React
    *   **路由**: React Router v6 (含路由守卫)
    *   **构建与部署**: Netlify (自动化 CI/CD)
*   **后端 (Backend)**:
    *   **核心服务**: Supabase (基于 PostgreSQL)
    *   **身份认证**: Supabase Auth (Email/Password)
    *   **数据库安全**: Row Level Security (RLS) 实现多租户数据隔离
    *   **高级鉴权**: PostgreSQL RPC (Remote Procedure Call) 函数
*   **云逻辑 (Cloud Logic)**:
    *   **定时任务**: Supabase pg_cron
    *   **业务逻辑**: Supabase Edge Functions (Deno / TypeScript)
*   **通知服务 (Notification)**:
    *   **邮件**: Resend API
    *   **微信**: PushPlus (微信公众号推送)

## 3. 核心功能模块

### 3.1 资产管理 (用户端)
*   **支持类型**: U-Key、CA证书、域名 (Domain)、服务器 (Server)、保险 (Insurance)、其他。
*   **CRUD操作**: 支持资产的增删改查。
*   **排序功能**: 支持按名称、类型、到期日进行升序/降序排列。
*   **个性化设置**: 用户可记录续费方式、关联网站及备注信息。

### 3.2 智能提醒策略
系统采用了激进的“**防遗漏**”提醒策略：
1.  **启动时间**: 资产到期前 **10天** 开始介入。
2.  **高频轰炸**: 每日发送 **3次** 提醒（北京时间 **09:30, 14:30, 21:00**），覆盖工作与休息时段。
3.  **持续追踪**: 若资产已过期且未在系统中更新日期，系统将**持续每日发送**严重过期警告，直到用户修改日期为止。

### 3.3 多渠道通知
*   **邮件通知**: HTML 格式邮件，根据剩余天数显示不同颜色（橙色预警、红色紧急）。
*   **微信通知**: 通过 PushPlus 接口推送到用户微信，支持手机端即时查看。
*   **通知管理**:
    *   用户可在 Dashboard 配置自己的 PushPlus Token。
    *   **按需关闭**: 单个资产支持“关闭提醒”开关。
    *   **安全确认**: 关闭提醒时弹出原生确认框，警示业务中断风险，防止误操作。

### 3.4 后台管理系统 (Admin Portal) - **[新增]**
*   **独立入口**: 专用的 `/admin/login` 和 `/admin/dashboard` 路径。
*   **超级管理员**: 独立的管理员账户体系，与普通用户数据隔离。
*   **数据大盘**:
    *   实时查看总注册用户数。
    *   监控今日邮件/微信发送量。
    *   **用户列表**: 查看所有注册用户的邮箱、注册时间、最后登录时间。
    *   **审计日志**: 查看详细的通知发送日志和用户登录日志。
*   **安全策略**:
    *   **本地环境限制**: 后台管理功能**仅限在本地服务器 (localhost/127.0.0.1) 访问**，云端环境自动屏蔽。
    *   **RPC 鉴权**: 使用 `is_admin()` 数据库函数绕过 RLS 限制，确保管理员权限检查的准确性和安全性。

## 4. 数据库设计摘要

### 4.1 `assets` 表 (资产表)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | uuid | 主键 |
| user_id | uuid | 关联 auth.users |
| name | text | 资产名称 |
| type | text | 资产类型 |
| expiry_date | date | 到期日期 |
| notification_enabled | boolean | 是否开启提醒 (默认 true) |
| websites | text[] | 关联网站数组 |

### 4.2 `profiles` 表 (用户配置表)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | uuid | 关联 auth.users |
| wechat_webhook | text | PushPlus Token |
| is_admin | boolean | 管理员标记 |

### 4.3 关键 RPC 函数
*   `public.is_admin()`: 安全地检查当前用户是否为管理员（Security Definer 模式）。
*   `public.get_all_users()`: 仅允许管理员调用的用户数据查询函数。

## 5. 开发与部署规范

*   **环境隔离**:
    *   **本地环境**: 允许完全访问前台与后台。
    *   **生产环境**: 仅开放前台用户功能，后台路由被 `LocalOnlyRoute` 组件拦截。
*   **代码管理**:
    *   **Git 策略**: 本地开发优先，所有代码修改需在本地测试通过。
    *   **推送限制**: **禁止自动推送**，必须经由人工确认后方可 `git push` 到远程仓库。
*   **部署信息**:
    *   **前端访问地址**: [https://u-key-reminder.netlify.app](https://u-key-reminder.netlify.app)
    *   **后端服务**: Supabase Project (owftlotklqlvtedevzsx)

## 6. 经验总结与最佳实践

1.  **权限管理**: 在处理管理员权限时，不要依赖受 RLS 限制的普通表查询。应使用 `Security Definer` 模式的 PostgreSQL RPC 函数来提升权限检查的可靠性，避免递归死锁。
2.  **路由安全**: 对于敏感的后台管理页面，除了后端的权限验证外，前端应实施物理级别的路由隔离（如检测 `window.location.hostname`），确保管理入口在公网不可见。
3.  **防遗漏策略**: 关键业务通知（如证书到期）应采用“确认机制”，即只有当用户执行了更新操作后，提醒才会停止，而非简单的定时发送。

---
*Generated by Trae AI Pair Programmer*
